/**
*@mainpage
* \brief \b Problem \b Application 6: A dictionary application
* \author Turcu Gabriel and Stoica Alexandru
* \date 30.05.2016
*/

#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<ctype.h>
#include "set.h"
/** The variable n will be used to store the number of commands our algorithm will go through. */
int n; 
/** The variable type will be used to store the current operation we will have to perform. */
int type;
/** The variable sectype will be our secondary @type value when we're in the Update case and need to see which Update case we need to perform. */
int sectype;
/** The variable defnumber is used to represent the number of definitions the word we're working with has. */
int defnumber;
/** Prameter used in different for's throughout the program.*/
int i;
/** Prameter used in different for's throughout the program.*/
int j;
/** Prameter used in different for's throughout the program.*/
int k;
/** The variable defnum is used in the case of Updating or Deleting a specific definition and represents the number of that definition.*/
int defnum;
/** The vector word is used to store the word we're currently working with. */;
char word[100];
/** The vector definition is used to store the current definition we're working with.*/
char definition[100]; 
/** The char matrix eword is used to store the entire content of the word we're currently updating.*/
char eword[1000][100]; 
set_node *set;
///> This is the file that contains the commands for the program.
FILE *fi;
/** Reading function used to initialize and see if our file exists and if it does, it reads n. @see n*/
int Reading()
{
	fi = fopen("test10.out", "r");
	if (fi == NULL)
		return 0;
	set_init(&set);
	fscanf(fi, "%d", &n); 
	return 1;
}
/** This function deals with Inserting a new word to the dictionary. @see word , definition and type .*/
void InsertSequence()    
{
	/*!
	* 	\param word The vector word is used to store the word we're currently inserting.
	* 	\param definition The vector definition is used to store the current definition we're going to insert.
	*/

	fscanf(fi, "%s", word);
	fgetc(fi);
	fgets(definition, 100, fi);
	///> We check if the word already exists and if it does not, we proceed with the InsertSequence().
	if (!(set_search(set, word, strcmp)))                 
	{
		///> We use set_insert() to insert the word in the set.
		set_insert(&set, word, strlen(word) + 1, strcmp);   
		FILE *f = fopen(word, "w");
		fprintf(f, "1\n");                 // We will use the first line of the file to store the number of definitions our word has. In the insert case, we initialize it with 1.
		fprintf(f, "%s\n", definition);                 // The definition as the second line in the file.
		fclose(f);
	}
}

void UpdateSequence()         /// This function deals with Updating a word from the dictionary.
{
	/// \param sectype The secondary type of our 4 cases mentioned above at main type 2
	fscanf(fi, "%d", &sectype);                 
	fgetc(fi);
	/// \param defnumber The number that represents the definition we'll update or remove.
	if ((sectype == 1) || (sectype == 4))                 /// For secondary type 1 and 4 we will also require the definition number we will update or delete. 
		fscanf(fi, "%d", &defnumber);
	fscanf(fi, "%s", word);
	fgetc(fi);
	if (sectype != 4 && sectype != 2)                 /// If secondary type is 2 or 4 we will not require a definition and therefore not read one.
		fgets(definition, 100, fi);
	/// ---------------------------------------------------------------------
	if (sectype == 1)               /// Secondary type 1 for updating a specific definition.
	{
		if (set_search(set, word, strcmp))
		{
			FILE *f = fopen(word, "r");
			fscanf(f, "%d", &defnum);                 /// We read the number of definitions our word currently has.
			fgetc(f);
			for (i = 0;i <= defnum - 1;i++)
				fgets(eword[i], 100, f);                 /// We put all our definitions in a char matrix, one for each line.
			strcpy(eword[defnumber - 1], definition);                 /// We update the definition by writing over it in the matrix our new definition.
			fclose(f);
			FILE *g = fopen(word, "w");                 // 
			fprintf(g, "%d\n", defnum);                 // 
			for (i = 0;i <= defnum - 1;i++)             // 
			{                                           //  Sequence for writing our modified matrix back in the file. 
				for (j = 0;eword[i][j] != '\0';j++)     // 
					fprintf(g, "%c", eword[i][j]);      //
														// 
			}
			fprintf(g, "\n");
			fclose(g);
		}
	}
	/// ---------------------------------------------------------------------
	if (sectype == 2)                 /// Secondary type 2 for clearing a word of its definitions.
	{
		if (set_search(set, word, strcmp))
		{
			FILE *f = fopen(word, "w");
			fprintf(f, "0\n");                 /// In order to clear a word of its definitions, we just reset the number of definitions on the first line with 0.
			fclose(f);
		}
	}
	/// ---------------------------------------------------------------------
	if (sectype == 3)                 /// Secondary type 3 for adding a new definition in the end to an already existing word.
	{
		if (set_search(set, word, strcmp))
		{
			FILE *f = fopen(word, "r");
			fscanf(f, "%d", &defnum);
			fgetc(f);
			for (i = 0;i <= defnum - 1;i++)
				fgets(eword[i], 100, f);
			defnum++;                 /// We increase the defnumber since we've added a new one in this case.
			strcpy(eword[defnum - 1], definition);                 /// We add the new definition on the last line of the matrix.
			fclose(f);
			FILE *g = fopen(word, "w");
			fprintf(g, "%d\n", defnum);
			for (i = 0;i <= defnum - 1;i++)						    // 
			{														//
				for (j = 0;eword[i][j] != '\0';j++)                 //   Sequence for writing our modified matrix back in the file.    
					fprintf(g, "%c", eword[i][j]);                  //
			}													    //
			fprintf(g, "\n");									    //
			fclose(g);
		}
	}
	/// ---------------------------------------------------------------------
	if (sectype == 4)                 /// Secondary type 4 for removing a definition of an already existing word.
	{
		if (set_search(set, word, strcmp))
		{
			FILE *f = fopen(word, "r");
			fscanf(f, "%d", &defnum);
			fgetc(f);
			for (i = 0;i <= defnum - 1;i++)                 /// We read the matrix of definitions from the file.
				fgets(eword[i], 100, f);
			for (i = defnumber;i <= defnum - 1;i++)
				strcpy(eword[i - 1], eword[i]);                 /// For each definition after the one we want to delete, we just move them one row back, deleting the definition we wanted to remove.
			defnum--;                 /// We decrease the number of definitions since we just deleted one.
			fclose(f);
			FILE *g = fopen(word, "w");
			fprintf(g, "%d\n", defnum);
			for (i = 0;i <= defnum - 1;i++)                         //
			{														//
				for (j = 0;eword[i][j] != '\0';j++)                 //    Sequence for writing our modified matrix back in the file.  
					fprintf(g, "%c", eword[i][j]);                  //
			}														//
			fprintf(g, "\n");                                       //
			fclose(g);
		}
	}
	/// @see defnumber, eword, sectype, word
}
void SearchSequence() /// This function deals with Searcing a word in the dictionary.
{
	/*!
	* 	\param word The vector word is used to store the word we're currently inserting.
	* 	\param eword The char matrix eword is used to store the entire content of the word we're currently displaying.
	*/
	fscanf(fi, "%s", word);
	fgetc(fi);
	if (set_search(set, word, strcmp))
	{
		FILE *f = fopen(word, "r");
		fscanf(f, "%d", &defnum);
		fgetc(f);
		for (i = 0;i <= defnum - 1;i++)                 /// Creating the matrix with the definitions for our word.
			fgets(eword[i], 100, f);
		printf("The definitions for the word %s are:\n", word);
		for (i = 0;i <= defnum - 1;i++)                 /// For this case we just print the content of the matrix for the respective word.
		{
			for (j = 0;eword[i][j] != '\0';j++)
				printf("%c", eword[i][j]);
		}
		printf("\n");
		fclose(f);
	}
}
void Compute()
{
	fscanf(fi, "%d", &type);                
	if (type == 1)                 /// Type 1 is for Inserting a word into the dictionary.
		InsertSequence();		
	else
		if (type == 2)                 /// Type 2 is for updating a word and it's definitions.
			UpdateSequence();		
		else
			if (type == 3)                /// Type 3 for looking up a word's definitions and displaying them in the console.
				SearchSequence();		
}
int main()
{
	/*
	*Different type explanations:
	*1 -> Straight up insert, requires name, definiton and will also add 1 to first line to specify 1 definition.
	*2 -> Splits into 4 cases: 1. Update a single definition.(Will be given as a parameter in the test cases)
	*						  2. Clear the word definitions.
	*                         3. Add a new definition for the respective word.
	*                         4. Remove a single definiton.(Will be given as a parameter in the test cases)
	*3 -> Look-up a word and show its definitions.
	*
	*How the file layout for each word will be:
	*First line will represent the number of definitions our word has.(defnum)
	*The next defnum lines will consist of strings where each one represents a definition for that word.
	*/
	if (!Reading())
	{
		printf("The file couldn't be opened.");
		return 0;
	}
	for (k = 1;k <= n;k++)
		Compute();
	system("pause");
	return 0;
}
